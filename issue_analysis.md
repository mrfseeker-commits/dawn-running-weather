# 지역 저장 오류 원인 분석 보고서

## 1. 문제 현상
- 사용자가 "지역 설정"에서 첫 번째 지역을 저장한 후, 두 번째 지역을 추가하려고 할 때 오류가 발생함.
- "이 지역은 이미 'OOO'(으)로 저장되어 있습니다"라는 메시지가 뜨거나, 무한 로딩 후 실패함.

## 2. 원인 분석

### 2.1. 지역 코드 중복 제한 (주요 원인)
네이버 날씨 서비스는 행정구역상 다른 동네라도 인접한 지역을 묶어 **동일한 지역 코드(Region Code)**를 사용하는 경우가 많습니다.
현재 시스템(`app.py`)은 데이터베이스에 지역을 저장할 때 **지역 코드의 중복을 허용하지 않도록** 설계되어 있습니다.

- **코드 위치**: `app.py` 274~280 라인
- **현상**: 예를 들어 `강남구 자곡동`과 `강남구 논현동`은 모두 코드 `07200580`을 사용합니다. 자곡동을 저장한 상태에서 논현동을 추가하려고 하면, 시스템은 "이미 저장된 지역 코드"로 인식하여 저장을 차단합니다.

### 2.2. 동기식 크롤링으로 인한 성능 저하 (부가 원인)
지역 추가 시 `update_weather_for_region` 함수가 실행되며 실시간으로 네이버 날씨를 크롤링합니다.
- **코드 위치**: `app.py` 295 라인
- **현상**: 크롤링(Playwright)은 약 5~10초 정도 소요되는 무거운 작업입니다. 이 작업이 완료될 때까지 서버 응답이 지연되므로, 사용자는 멈춘 것처럼 느끼거나 브라우저 타임아웃이 발생할 수 있습니다.

## 3. 해결 방안 (weather3 에서 진행 예정)

1.  **DB 스키마 및 로직 변경**:
    - `SavedLocation` 테이블에서 `region_code`의 유니크 제약 조건을 제거하거나, 로직을 수정하여 "지역 코드는 같아도 지역명(region_name)이 다르면 저장 가능"하도록 변경합니다.
    - 단, 날씨 데이터(`WeatherData`)는 지역 코드를 기준으로 하므로 중복 저장되지 않도록 효율적으로 관리해야 합니다.

2.  **비동기 처리 도입 (선택 사항)**:
    - 지역 추가 시 크롤링을 백그라운드에서 실행하거나, 사용자에게 "추가되었습니다. 데이터 수집 중..."이라는 메시지를 먼저 보여주고 나중에 데이터를 채우는 방식을 고려합니다.
